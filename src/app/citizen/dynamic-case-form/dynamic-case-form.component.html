<div class="container">
  <!-- Title -->
  <h2 class="page-title">
    <mat-icon>{{ icon }}</mat-icon>
    {{ caseNatureName || 'File New Petition' }}
  </h2>

  <form *ngIf="form" [formGroup]="form" (ngSubmit)="submit()">
    <!-- Case Nature (Read-only display) -->
    <div class="row mb-3" *ngIf="caseNatureName">
      <div class="col-12">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Case Nature (Service)</mat-label>
          <input matInput [value]="caseNatureName" readonly>
          <mat-icon matPrefix>gavel</mat-icon>
        </mat-form-field>
      </div>
    </div>

    <!-- Case Type Selection (Dropdown) -->
    <div class="row mb-3">
      <div class="col-12">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Filing Type *</mat-label>
          <mat-select [(ngModel)]="caseTypeId" [ngModelOptions]="{standalone: true}" required (selectionChange)="onCaseTypeChange(caseTypeId)">
            <mat-option [value]="null">-- Select Filing Type --</mat-option>
            <mat-option *ngFor="let caseType of caseTypes" [value]="caseType.id">
              {{ caseType.typeName }} ({{ caseType.courtLevel }})
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>description</mat-icon>
          <mat-spinner *ngIf="loadingCaseTypes" matSuffix diameter="20"></mat-spinner>
          <mat-error *ngIf="!caseTypeId">Please select a filing type</mat-error>
        </mat-form-field>
      </div>
    </div>

    <!-- Case Type Details (Court Level Info) -->
    <div class="row mb-3" *ngIf="selectedCaseType && courtLevel">
      <div class="col-12">
        <mat-card class="info-card">
          <mat-card-content>
            <div class="info-row">
              <mat-icon>info</mat-icon>
              <div class="info-content">
                <strong>Court Level:</strong> {{ courtLevel }}
                <span *ngIf="courtTypes.length > 0" class="ml-2">
                  <strong>Court Types:</strong> {{ courtTypes.join(', ') }}
                </span>
                <span *ngIf="selectedCaseType.isAppeal" class="ml-2 badge appeal-badge">
                  Appeal (Order: {{ selectedCaseType.appealOrder }})
                </span>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </div>

    <!-- Loading Schema Indicator -->
    <div *ngIf="loadingSchema" class="row mb-3">
      <div class="col-12 text-center">
        <mat-spinner diameter="30"></mat-spinner>
        <p class="mt-2">Loading form fields...</p>
      </div>
    </div>
    <!-- Dynamic Form Fields (only show when case type is selected and not loading) -->
    <ng-container *ngIf="caseTypeId && !loadingSchema">
      <!-- No fields configured -->
      <div *ngIf="groupedFields.length === 0" class="no-fields-message">
        <mat-icon>info</mat-icon>
        <p>No form fields are configured for this filing type. Select Unit and Court below, then submit if allowed.</p>
      </div>
      <ng-container *ngFor="let group of groupedFields">
        <div class="form-group-section mb-4">
          <h3 class="group-title">{{ group.groupLabel }}</h3>
          <div class="row">
            <ng-container *ngFor="let field of group.fields">
              <div
                *ngIf="isFieldVisible(field)"
                class="col-lg-4 col-md-6 col-sm-12 mb-3"
              >
        <!-- MATERIAL CONTROLS -->
        <ng-container *ngIf="field.fieldType !== 'FILE'">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>
              {{ field.fieldLabel }}
              <!-- <span *ngIf="field.isRequired" class="required">*</span> -->
            </mat-label>

            <!-- TEXT -->
            <input
              matInput
              *ngIf="field.fieldType === 'TEXT'"
              [formControlName]="field.fieldName"
              [placeholder]="field.placeholder"
              (blur)="onFieldValueChange(field.fieldName, form.get(field.fieldName)?.value)"
            />

            <!-- NUMBER -->
            <input
              matInput
              type="number"
              *ngIf="field.fieldType === 'NUMBER'"
              [formControlName]="field.fieldName"
              [placeholder]="field.placeholder"
              (blur)="onFieldValueChange(field.fieldName, form.get(field.fieldName)?.value)"
            />

            <!-- EMAIL -->
            <input
              matInput
              type="email"
              *ngIf="field.fieldType === 'EMAIL'"
              [formControlName]="field.fieldName"
              [placeholder]="field.placeholder"
              (blur)="onFieldValueChange(field.fieldName, form.get(field.fieldName)?.value)"
            />

            <!-- PHONE -->
            <input
              matInput
              type="tel"
              *ngIf="field.fieldType === 'PHONE'"
              [formControlName]="field.fieldName"
              [placeholder]="field.placeholder"
              (blur)="onFieldValueChange(field.fieldName, form.get(field.fieldName)?.value)"
            />

            <!-- DATE -->
            <input
              matInput
              *ngIf="field.fieldType === 'DATE'"
              [matDatepicker]="picker"
              [formControlName]="field.fieldName"
              (dateChange)="onFieldValueChange(field.fieldName, form.get(field.fieldName)?.value)"
            />
            <mat-datepicker-toggle
              matSuffix
              [for]="picker"
              *ngIf="field.fieldType === 'DATE'"
            ></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>

            <!-- SELECT / DROPDOWN -->
            <mat-select
              *ngIf="field.fieldType === 'SELECT' || field.fieldType === 'dropdown'"
              [formControlName]="field.fieldName"
              (selectionChange)="onFieldValueChange(field.fieldName, $event.value)"
            >
              <mat-option value="">-- Select --</mat-option>
              <!-- Options from fieldOptions (static) or dataSource (dynamic) -->
              <mat-option
                *ngFor="let opt of getFieldOptions(field)"
                [value]="opt.value"
              >
                {{ opt.label }}
              </mat-option>
            </mat-select>

            <!-- TEXTAREA -->
            <textarea
              matInput
              *ngIf="field.fieldType === 'TEXTAREA'"
              rows="3"
              [formControlName]="field.fieldName"
              [placeholder]="field.placeholder"
              (blur)="onFieldValueChange(field.fieldName, form.get(field.fieldName)?.value)"
            ></textarea>

            <!-- DATETIME -->
            <input
              matInput
              *ngIf="field.fieldType === 'DATETIME'"
              type="datetime-local"
              [formControlName]="field.fieldName"
              [placeholder]="field.placeholder"
              (blur)="onFieldValueChange(field.fieldName, form.get(field.fieldName)?.value)"
            />

            <!-- RADIO -->
            <mat-radio-group
              *ngIf="field.fieldType === 'RADIO'"
              [formControlName]="field.fieldName"
              (change)="onFieldValueChange(field.fieldName, $event.value)"
            >
              <mat-radio-button
                *ngFor="let opt of getFieldOptions(field)"
                [value]="opt.value"
              >
                {{ opt.label }}
              </mat-radio-button>
            </mat-radio-group>

            <!-- CHECKBOX -->
            <mat-checkbox
              *ngIf="field.fieldType === 'CHECKBOX'"
              [formControlName]="field.fieldName"
              (change)="onFieldValueChange(field.fieldName, $event.checked)"
            >
              {{ field.fieldLabel }}
            </mat-checkbox>

            <!-- Fallback: text input for other unhandled types -->
            <input
              matInput
              *ngIf="!['TEXT','NUMBER','DATE','DATETIME','SELECT','TEXTAREA','EMAIL','PHONE','RADIO','CHECKBOX'].includes(field.fieldType)"
              [formControlName]="field.fieldName"
              [placeholder]="field.placeholder"
              (blur)="onFieldValueChange(field.fieldName, form.get(field.fieldName)?.value)"
            />

            <!-- Error -->
            <mat-error
              *ngIf="
                form.get(field.fieldName)?.touched &&
                form.get(field.fieldName)?.invalid
              "
            >
              This field is required / invalid
            </mat-error>

            <!-- Hint -->
            <mat-hint *ngIf="field.helpText">
              {{ field.helpText }}
            </mat-hint>
          </mat-form-field>
        </ng-container>

        <!-- FILE INPUT (OUTSIDE mat-form-field) -->
        <ng-container *ngIf="field.fieldType === 'FILE'">
          <div
            class="mat-file-field"
            [class.mat-file-error]="
              form.get(field.fieldName)?.touched &&
              form.get(field.fieldName)?.invalid
            "
          >
            <label 
              [attr.for]="getFileInputId(field)" 
              class="mat-file-label"
            >
              {{ field.fieldLabel }}
              <span *ngIf="field.isRequired" class="required">*</span>
            </label>

            <div class="mat-file-control">
              <button
                mat-stroked-button
                color="primary"
                type="button"
                [attr.aria-label]="'Choose file for ' + field.fieldLabel"
                (click)="fileInput.click()"
              >
                Choose File
              </button>

              <span class="file-name">
                {{ form.get(field.fieldName)?.value?.name || "No file chosen" }}
              </span>

              <input
                #fileInput
                [id]="getFileInputId(field)"
                type="file"
                [attr.aria-label]="field.fieldLabel"
                style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0;"
                (change)="onFileChange($event, field.fieldName)"
              />
            </div>

            <!-- Error -->
            <div
              class="mat-file-error-text"
              *ngIf="
                form.get(field.fieldName)?.touched &&
                form.get(field.fieldName)?.invalid
              "
            >
              This field is required / invalid
            </div>

            <!-- Hint -->
            <div class="mat-file-hint" *ngIf="field.helpText">
              {{ field.helpText }}
            </div>
          </div>
        </ng-container>
              </div>
            </ng-container>
          </div>
        </div>
      </ng-container>
    </ng-container>

    <!-- Administrative Unit Selection -->
    <div class="row mb-3" *ngIf="caseTypeId">
      <div class="col-12">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Administrative Unit *</mat-label>
          <mat-select [(ngModel)]="selectedUnitId" [ngModelOptions]="{standalone: true}" required (selectionChange)="onUnitChange()">
            <mat-option [value]="null">-- Select Unit --</mat-option>
            <mat-option *ngFor="let unit of units" [value]="unit.unitId">
              {{ unit.unitName }} ({{ unit.unitLevel }})
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>location_city</mat-icon>
          <mat-hint *ngIf="citizenUnitId">Your registered unit will be used if not specified</mat-hint>
          <mat-error *ngIf="!selectedUnitId">Please select an administrative unit</mat-error>
        </mat-form-field>
      </div>
    </div>

    <!-- Court Selection (only show when case type and unit are selected) -->
    <div class="row mb-3" *ngIf="caseTypeId && selectedUnitId">
      <div class="col-12">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Court *</mat-label>
          <mat-select [(ngModel)]="courtId" [ngModelOptions]="{standalone: true}" required>
            <mat-option [value]="null">-- Select Court --</mat-option>
            <mat-option *ngFor="let court of courts" [value]="court.id">
              {{ court.courtName }} - {{ court.unitName || court.designation }}
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>account_balance</mat-icon>
          <mat-spinner *ngIf="loadingCourts" matSuffix diameter="20"></mat-spinner>
          <mat-error *ngIf="!courtId">Please select a court</mat-error>
        </mat-form-field>
      </div>
    </div>

    <div class="actions">
      <button 
        mat-raised-button 
        color="primary" 
        type="submit"
        [disabled]="isSubmitting || !caseTypeId || !selectedUnitId || !courtId || form.invalid"
      >
        <mat-spinner diameter="20" *ngIf="isSubmitting" class="inline-spinner"></mat-spinner>
        <span *ngIf="!isSubmitting">Submit Application</span>
        <span *ngIf="isSubmitting">Submitting...</span>
      </button>
      <button mat-stroked-button type="button" routerLink="/citizen/services" class="cancel-btn">
        Cancel
      </button>
    </div>
  </form>
</div>

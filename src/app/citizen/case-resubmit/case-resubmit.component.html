<div class="case-resubmit-container">
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <mat-icon>edit</mat-icon>
        Edit & Resubmit Case
      </h1>
      <p class="page-subtitle" *ngIf="case">{{ case.caseNumber }}</p>
    </div>
    <div class="header-actions">
      <button mat-raised-button color="primary" [routerLink]="['/citizen/cases', caseId]" class="back-btn">
        <mat-icon>arrow_back</mat-icon>
        Back to Case Details
      </button>
    </div>
  </div>

  <div class="page-content">
    <!-- Loading Spinner -->
    <div *ngIf="isLoading" class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Loading case details...</p>
    </div>

    <!-- Return Comment Notice -->
    <mat-card *ngIf="returnComment && !isLoading" class="warning-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon color="warn">warning</mat-icon>
          Correction Required
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <p class="return-comment">{{ returnComment }}</p>
      </mat-card-content>
    </mat-card>

    <!-- Resubmit Form -->
    <mat-card *ngIf="!isLoading && form" class="form-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>description</mat-icon>
          {{ caseTypeName }}
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="form" (ngSubmit)="submit()">
          <div class="row">
            <div
              *ngFor="let field of fields"
              class="col-lg-4 col-md-6 col-sm-12 mb-3"
            >
              <!-- MATERIAL CONTROLS -->
              <ng-container *ngIf="field.fieldType !== 'FILE'">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>
                    {{ field.fieldLabel }}
                  </mat-label>

                  <!-- TEXT -->
                  <input
                    matInput
                    *ngIf="field.fieldType === 'TEXT'"
                    [formControlName]="field.fieldName"
                    [placeholder]="field.placeholder"
                  />

                  <!-- NUMBER -->
                  <input
                    matInput
                    type="number"
                    *ngIf="field.fieldType === 'NUMBER'"
                    [formControlName]="field.fieldName"
                    [placeholder]="field.placeholder"
                  />

                  <!-- DATE -->
                  <input
                    matInput
                    *ngIf="field.fieldType === 'DATE'"
                    [matDatepicker]="picker"
                    [formControlName]="field.fieldName"
                  />
                  <mat-datepicker-toggle
                    matSuffix
                    [for]="picker"
                    *ngIf="field.fieldType === 'DATE'"
                  ></mat-datepicker-toggle>
                  <mat-datepicker #picker></mat-datepicker>

                  <!-- SELECT -->
                  <mat-select
                    *ngIf="field.fieldType === 'SELECT'"
                    [formControlName]="field.fieldName"
                  >
                    <mat-option value="">-- Select --</mat-option>
                    <mat-option
                      *ngFor="let opt of field.fieldOptions | jsonParse"
                      [value]="opt.value"
                    >
                      {{ opt.label }}
                    </mat-option>
                  </mat-select>

                  <!-- TEXTAREA -->
                  <textarea
                    matInput
                    *ngIf="field.fieldType === 'TEXTAREA'"
                    rows="3"
                    [formControlName]="field.fieldName"
                    [placeholder]="field.placeholder"
                  ></textarea>

                  <!-- Error -->
                  <mat-error
                    *ngIf="
                      form.get(field.fieldName)?.touched &&
                      form.get(field.fieldName)?.invalid
                    "
                  >
                    This field is required / invalid
                  </mat-error>
                </mat-form-field>
              </ng-container>

              <!-- FILE INPUT -->
              <ng-container *ngIf="field.fieldType === 'FILE'">
                <div
                  class="mat-file-field"
                  [class.mat-file-error]="
                    form.get(field.fieldName)?.touched &&
                    form.get(field.fieldName)?.invalid
                  "
                >
                  <label 
                    [attr.for]="getFileInputId(field)" 
                    class="mat-file-label"
                  >
                    {{ field.fieldLabel }}
                    <span *ngIf="field.isRequired" class="required">*</span>
                  </label>

                  <div class="mat-file-control">
                    <button
                      mat-stroked-button
                      color="primary"
                      type="button"
                      [attr.aria-label]="'Choose file for ' + field.fieldLabel"
                      (click)="fileInput.click()"
                    >
                      Choose File
                    </button>

                    <span class="file-name">
                      {{ form.get(field.fieldName)?.value?.name || "No file chosen" }}
                    </span>

                    <input
                      #fileInput
                      [id]="getFileInputId(field)"
                      type="file"
                      [attr.aria-label]="field.fieldLabel"
                      style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0;"
                      (change)="onFileChange($event, field.fieldName)"
                    />
                  </div>
                </div>
              </ng-container>
            </div>
          </div>

          <!-- Remarks Field -->
          <div class="row">
            <div class="col-12">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Remarks (Optional)</mat-label>
                <textarea
                  matInput
                  formControlName="remarks"
                  rows="3"
                  placeholder="Add any remarks about the corrections made"
                ></textarea>
                <mat-icon matPrefix>comment</mat-icon>
              </mat-form-field>
            </div>
          </div>

          <div class="actions">
            <button 
              mat-raised-button 
              color="primary" 
              type="submit"
              [disabled]="isSubmitting || form.invalid"
            >
              <mat-spinner diameter="20" *ngIf="isSubmitting" class="inline-spinner"></mat-spinner>
              <span *ngIf="!isSubmitting">Resubmit Case</span>
              <span *ngIf="isSubmitting">Submitting...</span>
            </button>
            <button 
              mat-stroked-button 
              type="button" 
              [routerLink]="['/citizen/cases', caseId]"
              [disabled]="isSubmitting"
            >
              Cancel
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  </div>
</div>

<div class="login-container">
  <!-- User Type Selection (Radio Buttons) -->
  <div class="user-type-selection">
    <mat-radio-group [(ngModel)]="selectedTab" (change)="onTabChange(selectedTab)" class="radio-group">
      <mat-radio-button [value]="0" class="radio-button">Citizen</mat-radio-button>
      <mat-radio-button [value]="1" class="radio-button">Officer</mat-radio-button>
      <mat-radio-button [value]="2" class="radio-button">Lawyer</mat-radio-button>
    </mat-radio-group>
  </div>

  <hr class="divider" />

  <!-- Login Method Selection -->
  <div class="login-method-selector">
    <button 
      mat-stroked-button 
      [class.active]="loginMethod === 'mobile'"
      (click)="onLoginMethodChange('mobile')"
      class="method-btn"
      [disabled]="selectedTab === 1">
      <mat-icon>phone</mat-icon>
      Mobile Number
    </button>
    <button 
      mat-stroked-button 
      [class.active]="loginMethod === 'password'"
      (click)="onLoginMethodChange('password')"
      class="method-btn">
      <mat-icon>lock</mat-icon>
      <ng-container *ngIf="selectedTab === 0 || selectedTab === 2; else officerLabel">
        Mobile/Email & Password
      </ng-container>
      <ng-template #officerLabel>
        UserID &amp; Password
      </ng-template>
    </button>
  </div>

  <!-- Mobile Login Form -->
  <form [formGroup]="mobileLoginForm" *ngIf="loginMethod === 'mobile'" (ngSubmit)="onMobileLogin()" class="login-form">
    <!-- OTP Success Message -->
    <div *ngIf="otpSuccessMessage" class="otp-alert otp-alert-success" role="alert">
      <mat-icon>check_circle</mat-icon>
      <span>{{ otpSuccessMessage }}</span>
    </div>

    <!-- Development: Show OTP Code -->
    <div *ngIf="otpCode" class="dev-otp-display">
      <mat-icon>info</mat-icon>
      <div class="dev-otp-content">
        <strong>Development Mode:</strong> OTP Code: <span class="otp-code">{{ otpCode }}</span>
      </div>
    </div>

    <!-- OTP Error Message -->
    <div *ngIf="otpErrorMessage" class="otp-alert otp-alert-error" role="alert">
      <mat-icon>error</mat-icon>
      <span>{{ otpErrorMessage }}</span>
    </div>

    <div class="form-row">
      <label class="form-label">
        Mobile No.
        <span class="required-star">*</span>
      </label>
      <mat-form-field appearance="outline" class="form-field">
        <input matInput formControlName="mobile" placeholder="Please Enter Mobile No." maxlength="10" [readonly]="otpSent || isSendingOtp">
        <mat-icon matPrefix>phone</mat-icon>
        <mat-error *ngIf="mobileLoginForm.get('mobile')?.hasError('required') && mobileLoginForm.get('mobile')?.touched">
          Mobile number is required
        </mat-error>
        <mat-error *ngIf="mobileLoginForm.get('mobile')?.hasError('pattern') && mobileLoginForm.get('mobile')?.touched">
          Please enter a valid 10-digit mobile number
        </mat-error>
      </mat-form-field>
    </div>

    <!-- Send OTP Button -->
    <div class="form-row">
      <button 
        mat-raised-button 
        color="accent" 
        type="button" 
        (click)="onSendOtp()"
        class="send-otp-button"
        [disabled]="mobileLoginForm.get('mobile')?.invalid || otpSent || isSendingOtp">
        <mat-spinner *ngIf="isSendingOtp" diameter="20" class="button-spinner"></mat-spinner>
        <span *ngIf="!isSendingOtp">Send OTP</span>
        <span *ngIf="isSendingOtp">Sending...</span>
      </button>
    </div>

    <!-- OTP Field -->
    <div class="form-row">
      <label class="form-label">
        Enter OTP
        <span class="required-star">*</span>
      </label>
      <mat-form-field appearance="outline" class="form-field">
        <input matInput formControlName="otp" placeholder="Enter 6-digit OTP" maxlength="6" [readonly]="!otpSent">
        <mat-icon matPrefix>pin</mat-icon>
        <mat-error *ngIf="mobileLoginForm.get('otp')?.hasError('required') && mobileLoginForm.get('otp')?.touched">
          OTP is required
        </mat-error>
        <mat-error *ngIf="mobileLoginForm.get('otp')?.hasError('pattern') && mobileLoginForm.get('otp')?.touched">
          OTP must be 6 digits
        </mat-error>
      </mat-form-field>
    </div>

    <!-- CAPTCHA Section -->
    <div class="form-row captcha-row">
      <div class="captcha-container">
        <div class="captcha-image">
          <div class="captcha-placeholder">{{ captchaText }}</div>
          <button mat-icon-button type="button" (click)="refreshCaptcha()" class="refresh-btn" aria-label="Reload Captcha">
            <mat-icon>refresh</mat-icon>
          </button>
        </div>
      </div>
    </div>

    <div class="form-row">
      <label class="form-label">
        Captcha
        <span class="required-star">*</span>
      </label>
      <mat-form-field appearance="outline" class="form-field">
        <input matInput formControlName="captcha" placeholder="Please enter Captcha Value" style="text-transform: uppercase;" maxlength="8">
        <mat-icon matPrefix>security</mat-icon>
        <mat-error *ngIf="mobileLoginForm.get('captcha')?.hasError('required') && mobileLoginForm.get('captcha')?.touched">
          Captcha is required
        </mat-error>
        <mat-error *ngIf="mobileLoginForm.get('captcha')?.hasError('invalid') && mobileLoginForm.get('captcha')?.touched">
          Invalid captcha
        </mat-error>
      </mat-form-field>
    </div>

    <!-- Login Error/Success Messages -->
    <div *ngIf="loginErrorMessage" class="otp-alert otp-alert-error" role="alert">
      <mat-icon>error</mat-icon>
      <span>{{ loginErrorMessage }}</span>
    </div>

    <div *ngIf="loginSuccessMessage" class="otp-alert otp-alert-success" role="alert">
      <mat-icon>check_circle</mat-icon>
      <span>{{ loginSuccessMessage }}</span>
    </div>

    <!-- Login Button -->
    <div class="button-row">
      <button 
        mat-raised-button 
        color="primary" 
        type="submit" 
        class="login-button" 
        [disabled]="mobileLoginForm.get('otp')?.invalid || mobileLoginForm.get('captcha')?.invalid || !otpSent || isLoggingIn">
        <mat-spinner *ngIf="isLoggingIn" diameter="20" class="button-spinner"></mat-spinner>
        <span *ngIf="!isLoggingIn">Sign in</span>
        <span *ngIf="isLoggingIn">Signing in...</span>
      </button>
      <button mat-stroked-button type="button" routerLink="/registration" class="register-button" *ngIf="selectedTab === 0">
        Registration
      </button>
    </div>
  </form>

  <!-- Password Login Form -->
  <form [formGroup]="passwordLoginForm" *ngIf="loginMethod === 'password'" (ngSubmit)="onPasswordLogin()" class="login-form">
    <div class="form-row">
      <label class="form-label">
        <ng-container *ngIf="selectedTab === 0; else officerUserIdLabel">
          Mobile No. / Email
        </ng-container>
        <ng-template #officerUserIdLabel>
          UserID (ROLE@COURT_CODE)
        </ng-template>
        <span class="required-star">*</span>
      </label>
      <mat-form-field appearance="outline" class="form-field">
        <input 
          matInput 
          formControlName="username" 
          [placeholder]="selectedTab === 0 ? 'Please Enter Mobile No. or Email' : 'e.g., SDC@DC_COURT_IMPHAL_EAST'">
        <mat-icon matPrefix>{{ selectedTab === 0 ? 'person' : 'badge' }}</mat-icon>
        <mat-error *ngIf="passwordLoginForm.get('username')?.hasError('required') && passwordLoginForm.get('username')?.touched">
          {{ selectedTab === 0 ? 'Mobile number or email is required' : 'UserID is required' }}
        </mat-error>
        <mat-error *ngIf="passwordLoginForm.get('username')?.hasError('invalid') && passwordLoginForm.get('username')?.touched">
          <ng-container *ngIf="selectedTab === 0; else officerUserIdError">
            Please enter a valid mobile number or email
          </ng-container>
          <ng-template #officerUserIdError>
            Invalid UserID format. Expected: ROLE@COURT_CODE (e.g., SDC@DC_COURT_IMPHAL_EAST)
          </ng-template>
        </mat-error>
      </mat-form-field>
    </div>

    <div class="form-row">
      <label class="form-label">
        Password
        <span class="required-star">*</span>
      </label>
      <mat-form-field appearance="outline" class="form-field">
        <input matInput type="password" formControlName="password" placeholder="Please Enter Password">
        <mat-icon matPrefix>lock</mat-icon>
        <mat-error *ngIf="passwordLoginForm.get('password')?.hasError('required') && passwordLoginForm.get('password')?.touched">
          Password is required
        </mat-error>
        <mat-error *ngIf="passwordLoginForm.get('password')?.hasError('minlength') && passwordLoginForm.get('password')?.touched">
          Password must be at least 6 characters
        </mat-error>
      </mat-form-field>
    </div>

    <!-- CAPTCHA Section (Citizen only) -->
    <ng-container *ngIf="selectedTab === 0">
      <div class="form-row captcha-row">
        <div class="captcha-container">
          <div class="captcha-image">
            <div class="captcha-placeholder">{{ passwordCaptchaText }}</div>
            <button mat-icon-button type="button" (click)="refreshPasswordCaptcha()" class="refresh-btn" aria-label="Reload Captcha">
              <mat-icon>refresh</mat-icon>
            </button>
          </div>
        </div>
      </div>

      <div class="form-row">
        <label class="form-label">
          Captcha
          <span class="required-star">*</span>
        </label>
        <mat-form-field appearance="outline" class="form-field">
          <input matInput formControlName="captcha" placeholder="Please enter Captcha Value" style="text-transform: uppercase;" maxlength="8">
          <mat-icon matPrefix>security</mat-icon>
          <mat-error *ngIf="passwordLoginForm.get('captcha')?.hasError('required') && passwordLoginForm.get('captcha')?.touched">
            Captcha is required
          </mat-error>
          <mat-error *ngIf="passwordLoginForm.get('captcha')?.hasError('invalid') && passwordLoginForm.get('captcha')?.touched">
            Invalid captcha
          </mat-error>
        </mat-form-field>
      </div>
    </ng-container>

    <!-- Password Login Error/Success Messages -->
    <div *ngIf="passwordLoginErrorMessage" class="otp-alert otp-alert-error" role="alert">
      <mat-icon>error</mat-icon>
      <span>{{ passwordLoginErrorMessage }}</span>
    </div>

    <div *ngIf="passwordLoginSuccessMessage" class="otp-alert otp-alert-success" role="alert">
      <mat-icon>check_circle</mat-icon>
      <span>{{ passwordLoginSuccessMessage }}</span>
    </div>

    <div class="button-row">
      <button 
        mat-raised-button 
        color="primary" 
        type="submit" 
        class="login-button" 
        [disabled]="passwordLoginForm.invalid || isPasswordLoggingIn">
        <mat-spinner *ngIf="isPasswordLoggingIn" diameter="20" class="button-spinner"></mat-spinner>
        <span *ngIf="!isPasswordLoggingIn">Sign in</span>
        <span *ngIf="isPasswordLoggingIn">Signing in...</span>
      </button>
      <button mat-stroked-button type="button" routerLink="/registration" class="register-button" *ngIf="selectedTab === 0" [disabled]="isPasswordLoggingIn">
        Registration
      </button>
    </div>
  </form>
</div>

